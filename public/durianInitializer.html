<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="contract.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <title>DurianChain</title>

    <style>
        body {
            background-image: linear-gradient(
                rgba(0, 0, 0, 0.5),
                rgba(0, 0, 0, 0.5)
            ),
            url("https://www.myfreetextures.com/wp-content/uploads/2014/11/another-flowing-blue-abstract-texture.jpg");
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: cover;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        header {
            /* background-color: #146C94; */
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }
        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }
        nav li {
            margin: 0 10px;
        }
        nav a {
            color: #fff;
            text-decoration: none;
            padding: 10px;
        }
        nav a:hover {
            background-color: #fff;
            color: #146c94;
            border-radius: 5px;
        }
        nav a {
            transition: all 0.3s ease 0s;
        }
        img {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }
        /* Slideshow container */
        .slideshow-container {
            max-width:fit-content;
            position: relative;
            margin: auto;
            border-radius: 20px;
        }

        /* Hide the images by default */
        .mySlides {
            display: none;
            height: 50vh;
            width: 50vw;
        }

        /* Next and previous buttons */
        .prev,
        .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            margin-top: -22px;
            padding: 16px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
        }

        /* Position the next button */
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }

        /* On hover, add a black background color with a little bit see-through */
        .prev:hover,
        .next:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Caption text */
        .text {
            color: #f2f2f2;
            font-size: 15px;
            padding: 8px 12px;
            position: absolute;
            bottom: 8px;
            width: 100%;
            text-align: center;
        }

        /* Number text (1/3 etc) */
        .numbertext {
            color: #f2f2f2;
            font-size: 12px;
            padding: 8px 12px;
            position: absolute;
            top: 0;
        }
        .init-form {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            margin: 20px auto;
            width: 80vw;
        }
        .init-form h2 {
            text-align: center;
        }
        .init-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        input:focus {
            outline: none;
        }

        form label {
            font-size: 1em;
        }
        form input {
            font-size: 1em;
        }
        form button {
            font-size: 1em;
            margin-top: 10px;
            background-color: #146C94;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            transition: all 0.3s ease 0s;
        }
        form button:hover {
            border-radius: 5px;
            opacity: 0.9;
        }
        form input[type="text"]:focus {
            outline: none;
        }
        input[type="text"] {
            width: 60%;
        }
        .input-segment {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-segment label {
            width: 120px;
            text-align: right;
            margin-right: 10px;
        }
        .input-segment input {
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    </style>
  </head>
  <body>
    <header>
      <h1 style="margin-left: 2vw">DurianChain</h1>
      <nav>
        <ul>
          <li><a href="./homepage.html">Home</a></li>
          <li id="durianInit"><a href="./durianInitializer.html">Durian Initializer</a></li>
          <li><a href="./durianRequest.html">Durian Request</a></li>
          <li><a href="./durianTracking.html">Durian Tracking</a></li>
          <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="slideshow-container">
        <div class="mySlides fade">
          <img
            src="https://4.bp.blogspot.com/-BU_MhjlzF5w/VwY2yCxjOkI/AAAAAAAAHPE/WaiAcIxFCEE9CdZWmJXL8y_8M9Tg4ZGtg/s1600/black%2Bthorn%2B-phot%2BDurian%2BKing-%2BFb.jpg"
            style="width: 100%"
          />
        </div>
        <div class="mySlides fade">
          <img
            src="https://live.staticflickr.com/65535/51273950389_86737602fc_z.jpg"
            style="width: 100%"
          />
        </div>
        <div class="mySlides fade">
          <img
            src="https://cf.shopee.com.my/file/7346bdffdb1aec7387191c4b75d919c4"
            style="width: 100%"
          />
        </div>
        <div class="mySlides fade">
          <img
            src="https://www.optionstheedge.com/sites/default/files/field/featured-image/2021/raya_kunyit.png"
            style="width: 100%"
          />
        </div>
        <div class="mySlides fade">
          <img
            src="https://fruitmonkeys.com.sg/image/catalog/Products%20(new)/XO.jpg"
            style="width: 100%"
          />
        </div>
        <div class="mySlides fade">
          <img
            src="https://fruitmonkeys.com.sg/image/catalog/Products%20(new)/XO.jpg"
            style="width: 100%"
          />
        </div>

        <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
        <a class="next" onclick="plusSlides(1)">&#10095;</a>
      </div>

      <div class="init-area">
        <div id="reg-tree">
          <form class="init-form">
            <h2>Register Tree</h2>
            <div class="input-segment">
                <label for="species">Species: </label>
                <!-- <input type="text" id="species" name="species" placeholder="Species.." required>  -->
                <select style="font-size: 16px" name="species" id="species">
                  <option value="blackthorn">Black Thorn</option>
                  <option value="d101">D101</option>
                  <option value="d24">D24</option>
                  <option value="musangking">Musang King</option>
                  <option value="redprawn">Red Prawn</option>
                  <option value="xo">XO</option>
                </select>
              <br /><br />
            </div>
            <button onclick="regTree()" id="reg-tree-btn">Register Tree</button>
          </form>    
        </div>
        <div id="reg-durian">
          <form class="init-form">
            <h2>Register Durian</h2>
            <div class="input-segment">
              <label for="treeID">Tree ID:</label>
              <input type="text" id="treeID" name="treeID" placeholder="TreeID.." required>
            </div>
            <p id="treeArea"></p>  
            <button onclick="getTreeSpecies()" style="margin: 0 0 10px 0;">Display Species</button>
            <div class="input-segment">
              <label for="weight">Weight (g):</label>
              <input type="number" id="weight" name="weight" placeholder="Weight (g).." required>    
            </div>
            <div class="input-segment">
              <label for="timeHarvest">Time Harvested:</label>
              <input type="datetime-local" id="timeHarvest" name="timeHarvest" required>    
            </div>
            <div class="input-segment">
              <label for="workerHarvest">Worker Harvested:</label>
              <input type="text" id="workerHarvest" name="workerHarvest" placeholder="Worker Harvested.." required>    
            </div>
            <div class="input-segment">
              <label for="desc">Description:</label>
              <input type="text" id="desc" name="desc" placeholder="Description.." required>    
            </div>
            <button onclick="regDurian()" id="reg-durian-btn">Register Durian</button>
          </form>  
        </div>  
      </div>
    </main>

    <script>
      var slideIndex = 1;
      showSlides(slideIndex);

      // Next/previous controls
      function plusSlides(n) {
        showSlides((slideIndex += n));
      }

      // Thumbnail image controls
      function currentSlide(n) {
        showSlides((slideIndex = n));
      }

      function showSlides(n) {
        var i;
        var slides = document.getElementsByClassName("mySlides");
        if (n > slides.length) {
          slideIndex = 1;
        }
        if (n < 1) {
          slideIndex = slides.length;
        }
        for (i = 0; i < slides.length; i++) {
          slides[i].style.display = "none";
        }
        slides[slideIndex - 1].style.display = "block";
      }

      const regTree = async () => {
        const speciesType = getSpecies(document.getElementById('species').value);
        await window.contract.methods.registerTree(speciesType).send({ from: account })
        .then(() => {
          alert('You have successfully register a tree');
         })
      };

          const getTreeSpecies = async () => {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const address = accounts[0];
          const id = document.getElementById("treeID").value;
          const length = await window.contract.methods.getTreeInLength().call({ from: address });
          var tempSpecies;
          var detected=false;
          
          for (let i = 0; i < length; i++) {
              const treeData = await window.contract.methods.TreeIn(address, i).call({ from: address });
              
              if (treeData.treeID === id) {
                tempSpecies=treeData.treeSpecies;
                  detected=true;
                  break;
              }
          }
          if(detected){
            document.getElementById("treeArea").innerHTML = `Detected Species: ${tempSpecies}`;
          }
          else{
            document.getElementById("treeArea").innerHTML = `Detected Species: Tree Not Exist`;
          }

      };

      function getSpecies(species) {
        switch (species) {
          case "blackthorn":
            return 0;
          case "d101":
            return 1;
          case "d24":
            return 2;
          case "musangking":
            return 3;
          case "redprawn":
            return 4;
          case "xo":
            return 5;
          default:
            return -1;
        }
      }

      const regDurian = async () => {
        const treeID = document.getElementById("treeID").value;
        const weight = parseInt(document.getElementById("weight").value);
        const timeHarvest = document.getElementById("timeHarvest").value;
        const unixTimestamp = Date.parse(timeHarvest) / 1000; // divide by 1000 to convert to seconds
        const secondsPerBlock = 15;
        const blockTimestamp = Math.floor(unixTimestamp / secondsPerBlock) * secondsPerBlock;
        const workerHarvest = document.getElementById("workerHarvest").value;
        const desc = document.getElementById("desc").value;
        await window.contract.methods
          .registerDurian(treeID, weight, blockTimestamp, workerHarvest, desc)
          .send({ from: account })
          .then((regDurian) => {
            alert("You have successfully register a durian");
          });
      };

      const logout = async () => {
        await window.contract.methods.logout().send({ from: account })
        .then((logout) => {
          alert('You have successfully logout from account');
          window.location.href="/registration.html";
         });
      };

      const durianInitDisable = async () => {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const address = accounts[0];
        const user = await window.contract.methods.user(address).call({ from: account });
        if (user.UserType != 0) {
          $("#durianInit").hide();
        }
      }

      durianInitDisable();
    </script>
  </body>
</html>
